<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>从源码编译Pytorch | Avalon</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="alternate" type="application/rss+xml" href="https://blog.mediosz.club/rss.xml" title="Avalon RSS Feed">
    <meta name="description" content="

阅读Pytorch的源码的第一步，首先要获取Pytorch的源代码，然后自己构建一下Pytorch，这样可以对Pytorch有一个粗略的了解，比如Pytorch包含哪些模块，每一个模块的作用是什么，这对我们后续阅读源码会有帮助，本文假设，读者有一定的编码经验，因此不会介绍过多细节。

之前说到， ...">
    
    <link rel="preload" href="/blog/assets/css/0.styles.14fb6a50.css" as="style"><link rel="preload" href="/blog/assets/js/app.bdc094dc.js" as="script"><link rel="preload" href="/blog/assets/js/6.e456ea1d.js" as="script"><link rel="preload" href="/blog/assets/js/3.78c3d3c8.js" as="script"><link rel="preload" href="/blog/assets/js/15.dab0a3f7.js" as="script"><link rel="preload" href="/blog/assets/js/10.70f7a74d.js" as="script"><link rel="prefetch" href="/blog/assets/js/11.dd6dac4c.js"><link rel="prefetch" href="/blog/assets/js/12.2cde1e42.js"><link rel="prefetch" href="/blog/assets/js/13.9bcf6dc7.js"><link rel="prefetch" href="/blog/assets/js/14.b5f285d2.js"><link rel="prefetch" href="/blog/assets/js/16.882af9f6.js"><link rel="prefetch" href="/blog/assets/js/17.3c6c9032.js"><link rel="prefetch" href="/blog/assets/js/18.3dc9eb95.js"><link rel="prefetch" href="/blog/assets/js/19.03ff0086.js"><link rel="prefetch" href="/blog/assets/js/20.52b478b9.js"><link rel="prefetch" href="/blog/assets/js/21.31eef441.js"><link rel="prefetch" href="/blog/assets/js/22.de0c58e9.js"><link rel="prefetch" href="/blog/assets/js/23.eb999a8b.js"><link rel="prefetch" href="/blog/assets/js/24.ccdd51aa.js"><link rel="prefetch" href="/blog/assets/js/25.d46a83f2.js"><link rel="prefetch" href="/blog/assets/js/26.2e209b64.js"><link rel="prefetch" href="/blog/assets/js/27.095bf57b.js"><link rel="prefetch" href="/blog/assets/js/28.ca0de492.js"><link rel="prefetch" href="/blog/assets/js/29.c6494259.js"><link rel="prefetch" href="/blog/assets/js/30.ec38b16b.js"><link rel="prefetch" href="/blog/assets/js/31.f57c5fbc.js"><link rel="prefetch" href="/blog/assets/js/32.c6a91f86.js"><link rel="prefetch" href="/blog/assets/js/33.34834785.js"><link rel="prefetch" href="/blog/assets/js/34.987559e0.js"><link rel="prefetch" href="/blog/assets/js/35.4e567c68.js"><link rel="prefetch" href="/blog/assets/js/36.cf11feb6.js"><link rel="prefetch" href="/blog/assets/js/37.316dd84c.js"><link rel="prefetch" href="/blog/assets/js/38.b7c1727f.js"><link rel="prefetch" href="/blog/assets/js/39.59bfb827.js"><link rel="prefetch" href="/blog/assets/js/4.4b1cad09.js"><link rel="prefetch" href="/blog/assets/js/40.3d9526e4.js"><link rel="prefetch" href="/blog/assets/js/41.ee103e02.js"><link rel="prefetch" href="/blog/assets/js/42.dce26146.js"><link rel="prefetch" href="/blog/assets/js/5.7ade25e8.js"><link rel="prefetch" href="/blog/assets/js/7.66f7834c.js"><link rel="prefetch" href="/blog/assets/js/8.1e244325.js"><link rel="prefetch" href="/blog/assets/js/9.7967ab28.js"><link rel="prefetch" href="/blog/assets/js/vuejs-paginate.17238d84.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.14fb6a50.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/blog/" class="nav-link home-link">Avalon </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/blog/" class="nav-link">中文</a></li><li class="nav-item"><a href="/blog/en/" class="nav-link">English</a></li><li class="nav-item"><a href="/blog/tag/" class="nav-link">标签</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/blog/" class="nav-link mobile-home-link">Avalon </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/blog/" class="nav-link">中文</a></li><li class="mobile-nav-item"><a href="/blog/en/" class="nav-link">English</a></li><li class="mobile-nav-item"><a href="/blog/tag/" class="nav-link">标签</a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">从源码编译Pytorch</h1><div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg><span itemprop="name">Tricster</span><span itemprop="address">  in 南京</span></div><div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><time pubdate itemprop="datePublished" datetime="2021-04-02T00:00:00.000Z">Fri Apr 02 2021</time></div><ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-a940ee60><a href="/blog/tag/tech" data-v-a940ee60> tech </a></li></ul></div></header><div itemprop="articleBody" class="content__default"><h1 id="如何从源码编译pytorch"><a href="#如何从源码编译pytorch" class="header-anchor">#</a> 如何从源码编译Pytorch？</h1> <p>阅读Pytorch的源码的第一步，首先要获取Pytorch的源代码，然后自己构建一下Pytorch，这样可以对Pytorch有一个粗略的了解，比如Pytorch包含哪些模块，每一个模块的作用是什么，这对我们后续阅读源码会有帮助，本文假设，读者有一定的编码经验，因此不会介绍过多细节。</p> <p>之前说到，本系列会从<code>v0.3.0</code>开始，一步一步阅读，这样的考虑主要是因为，从<code>v0.4.0</code>开始，Pytorch架构发生了较大的改变，从低版本开始阅读更容易把握到Pytorch的架构。</p> <p>但之前也有读者提到，<code>v0.3.0</code>确实是太过于古老，接着这次重新编译Pytorch的机会，我们将源码升级到最新（截止目前，最新版本为<code>v1.9</code>），之后的阅读也会直接从<code>v1.9</code>出发，方便各位读者学习更新的内容，话不多说，我们正式开始，先做一些准备工作。</p> <h2 id="前期准备工作"><a href="#前期准备工作" class="header-anchor">#</a> 前期准备工作</h2> <p>与Pytorch官方文档中一致，我们也使用Conda来管理环境。简单介绍一下Conda，Conda可以为我们创建出若干隔离的环境，在每个环境中，我们都可以按需求安装一些库和软件，这样的隔离可以方便我们排除一些干扰。Conda还有一些好处，比如可以为环境指定Python版本，同时也可以方便地使用不同版本的Python。</p> <p>首先我们使用Conda创建一个环境。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>conda create <span class="token parameter variable">-n</span> <span class="token string">&quot;pytorch&quot;</span> <span class="token assign-left variable">PYTHON</span><span class="token operator">=</span><span class="token number">3.6</span>
conda activate pytorch
</code></pre></div><p>使用上面的指令，我们创建了一个名字为&quot;pytorch&quot;的环境，使用Python3.6，这里使用Python3.6是出于兼容性考虑。</p> <p>本文使用Ubuntu18.04作为宿主机。接下来安装一些必要的库：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>conda <span class="token function">install</span> numpy ninja pyyaml mkl mkl-include setuptools cmake cffi typing_extensions <span class="token punctuation">\</span>
   future six requests dataclasses magma-cuda110 lapack <span class="token parameter variable">-c</span> pytorch <span class="token parameter variable">-c</span> conda-forge
</code></pre></div><p>Conda会在当前环境里为我们安装这些依赖，使用Windows或者MacOS的读者，需要根据官方仓库中的说明，安装对应的依赖。</p> <h2 id="开始编译"><a href="#开始编译" class="header-anchor">#</a> 开始编译</h2> <p>完成上述步骤后，我们正式开始编译，首先获取源码。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 使用git从Github上克隆源码，注意 --recursive 是必要的，因为我们需要克隆第三方依赖库。</span>
<span class="token function">git</span> clone <span class="token parameter variable">--recursive</span> https://github.com/pytorch/pytorch
<span class="token builtin class-name">cd</span> pytorch
</code></pre></div><p>获取源码后，首先检查一下<code>third_party</code>文件夹中是否有文件，如果没有文件或文件不全的话，需要运行如下命令获取这些依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 更新子模块</span>
<span class="token function">git</span> submodule <span class="token function">sync</span>
<span class="token function">git</span> submodule update <span class="token parameter variable">--init</span> <span class="token parameter variable">--recursive</span>
</code></pre></div><p>之后我们可以开始编译了。要确保，系统中已经安装好<code>cmake</code>，Conda中已经安装了Cmake。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 安装torch到python的库目录</span>
python setup.py <span class="token function">install</span>
<span class="token comment"># 只编译不进行安装</span>
python setup.py develop 
</code></pre></div><p>注意在这里，我们选择<code>develop</code>作为setup的选项，这样的话，编译好的文件将不会安装到Python的目录中，这样可以避免我们自己编译的库与其他安装的库发生冲突。
正常完成编译，没有错误之后，再进行下一步。</p> <h1 id="pytorch编译过程解析"><a href="#pytorch编译过程解析" class="header-anchor">#</a> Pytorch编译过程解析</h1> <p>Pytorch混合了多种语言，主要是Python与C++，于是从源码编译要求读者对C++也有一定了解，比如知晓C++程序的编译过程。为了处理大型C++项目，Pytorch中也使用了CMake作为组织整个项目的工具，不熟悉Cmake的读者，不妨先去了解一下什么是CMake。</p> <h2 id="cmake-简要介绍"><a href="#cmake-简要介绍" class="header-anchor">#</a> Cmake 简要介绍</h2> <p>Cmake是一个广泛使用的构建系统生成器（Build System Generator），用来组织C++项目，然后生成一系列编译指令，交给构建系统（Build System），最终生成出一个可执行文件或是库文件。</p> <p>举个简单的例子，我们想要盖一个商场，首先需要一个建筑的图纸，然后将图纸交给施工队，施工队帮我们完成商场的建设。于是我们先用Cmake这个工具，画一个蓝图出来，然后交给施工队（make，ninja）就能得到我们想要的商场，这个过程中，源代码就像是砖头和其他建材。</p> <p>Cmake需要一系列<code>CMakeLists.txt</code>来发挥作用，我们就在这个文件中，编写如何生成最后的程序。每一个文件夹中会有一个<code>CMakeLists</code>，这样Cmake便可以组织起整个目录。</p> <p>这里给出一个简单的cmake工程，文件目录如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">.</span>
├── CMakeLists.txt
├── Demo
│   └── CMakeLists.txt
└── Hello
    └── CMakeLists.txt
</code></pre></div><h3 id="root"><a href="#root" class="header-anchor">#</a> root</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>cmake_minimum_required <span class="token punctuation">(</span>VERSION <span class="token number">2.8</span>.11<span class="token punctuation">)</span>
project <span class="token punctuation">(</span>HELLO<span class="token punctuation">)</span>

add_subdirectory <span class="token punctuation">(</span>Hello<span class="token punctuation">)</span>
add_subdirectory <span class="token punctuation">(</span>Demo<span class="token punctuation">)</span>
</code></pre></div><h3 id="hello"><a href="#hello" class="header-anchor">#</a> Hello</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>add_library <span class="token punctuation">(</span>Hello hello.cxx<span class="token punctuation">)</span>
target_include_directories <span class="token punctuation">(</span>Hello PUBLIC <span class="token variable">${CMAKE_CURRENT_SOURCE_DIR}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="demo"><a href="#demo" class="header-anchor">#</a> Demo</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>add_executable <span class="token punctuation">(</span>helloDemo demo.cxx demo_b.cxx<span class="token punctuation">)</span>
target_link_libraries <span class="token punctuation">(</span>helloDemo LINK_PUBLIC Hello<span class="token punctuation">)</span>
</code></pre></div><p>在根目录中，我们指明工程名字是<code>HELLO</code>，在Hello文件夹中，我们生成了一个叫做<code>Hello</code>的静态库，在Demo文件夹中，我们生成一个叫做<code>helloDemo</code>的可执行文件，并与<code>Hello</code>库进行链接，然后得到最终的可执行文件。这个例子虽然简单，但几乎所有的Cmake工程，都会遵循这样的一个范式，理解这样编译的流程，对我们理解Pytorch编译很有帮助。</p> <p>再次建议想要阅读源码的读者先去系统地学习一下Cmake，否则将无法了解Pytorch的构建过程。接下来，我们正式开始看一下Pytorch的整个构建过程。</p> <h2 id="setup-py"><a href="#setup-py" class="header-anchor">#</a> setup.py</h2> <p>与其他Python库一样，在Pytorch源码的根目录下，有一个文件叫做<code>setup.py</code>，这个文件是Pytorch生成的入口文件，里面定义了Pytorch的构建过程，检查了第三方依赖库的完整性，并且声明了Pytorch的基本信息，比如名字，版本号，描述信息，作者信息等等，这些信息是每一个Python库都需要的。看一下经过简化的<code>main</code>函数：</p> <div class="language-python extra-class"><pre class="language-python"><code>   dist <span class="token operator">=</span> Distribution<span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment"># 处理命令行参数</span>
   dist<span class="token punctuation">.</span>parse_command_line<span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment"># 构建依赖库</span>
   build_deps<span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment"># 生成拓展所需的部分</span>
   extensions<span class="token punctuation">,</span> cmdclass<span class="token punctuation">,</span> packages<span class="token punctuation">,</span> entry_points<span class="token punctuation">,</span> install_requires <span class="token operator">=</span> configure_extension_build<span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token comment"># 构成Python库</span>
   setup<span class="token punctuation">(</span>
      name<span class="token operator">=</span>package_name<span class="token punctuation">,</span>
      version<span class="token operator">=</span>version<span class="token punctuation">,</span>
      description<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;Tensors and Dynamic neural networks in Python with strong GPU acceleration&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      long_description<span class="token operator">=</span>long_description<span class="token punctuation">,</span>
      long_description_content_type<span class="token operator">=</span><span class="token string">&quot;text/markdown&quot;</span><span class="token punctuation">,</span>
      ext_modules<span class="token operator">=</span>extensions<span class="token punctuation">,</span>
      cmdclass<span class="token operator">=</span>cmdclass<span class="token punctuation">,</span>
      packages<span class="token operator">=</span>packages<span class="token punctuation">,</span>
      entry_points<span class="token operator">=</span>entry_points<span class="token punctuation">,</span>
      install_requires<span class="token operator">=</span>install_requires<span class="token punctuation">,</span>
      package_data<span class="token operator">=</span><span class="token punctuation">{</span>
         <span class="token string">'torch'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
         <span class="token string">'caffe2'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
         <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      url<span class="token operator">=</span><span class="token string">'https://pytorch.org/'</span><span class="token punctuation">,</span>
      download_url<span class="token operator">=</span><span class="token string">'https://github.com/pytorch/pytorch/tags'</span><span class="token punctuation">,</span>
      author<span class="token operator">=</span><span class="token string">'PyTorch Team'</span><span class="token punctuation">,</span>
      author_email<span class="token operator">=</span><span class="token string">'packages@pytorch.org'</span><span class="token punctuation">,</span>
      python_requires<span class="token operator">=</span><span class="token string">'&gt;={}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>python_min_version_str<span class="token punctuation">)</span><span class="token punctuation">,</span>
      license<span class="token operator">=</span><span class="token string">'BSD-3'</span><span class="token punctuation">,</span>
      keywords<span class="token operator">=</span><span class="token string">'pytorch machine learning'</span><span class="token punctuation">,</span>
   <span class="token punctuation">)</span>

</code></pre></div><h3 id="命令行参数"><a href="#命令行参数" class="header-anchor">#</a> 命令行参数</h3> <p>这个容易理解，Pytorch里面有非常多的选项，比如是否要开启调试信息，是否要启用CUDA，是否要编译测试代码，是否要进行编译分布式的代码，都可以通过向命令行传编译选项来进行控制，而不需要对编译代码进行改动。</p> <h3 id="编译依赖"><a href="#编译依赖" class="header-anchor">#</a> 编译依赖</h3> <p>接下来是重头戏，这一步编译了所有我们需要的C++库，包括依赖库和Pytorch的源码。主要分为两步：</p> <ol><li>检查第三方库的源码的完整性。</li> <li>编译依赖库，libtorch，libc10等。</li></ol> <p>还记得我们在下载pytorch源码的时候执行了<code>git submodule update --init --recursive</code>吗，这条命令帮我们下载了Pytorch的依赖库，这些库是托管在其他仓库里的，统一被下载到了<code>third_party</code>下面，在编译之前，第一步是检查一下是否所有所有的依赖库都被完整地下载好，如果有缺失，则会报错并退出。</p> <p>之后便是使用Cmake对整个工程进行构建，Pytorch对Cmake进行了一个简单的封装，可以在python代码中调用Cmake，具体构建的过程我们下一节详细介绍。</p> <h3 id="整理pytorch需要的拓展"><a href="#整理pytorch需要的拓展" class="header-anchor">#</a> 整理Pytorch需要的拓展</h3> <p>还记得我们上一篇文章讲过，Pytorch以一个拓展的方式与Python代码进行耦合吗，这一部分就整理了Pytorch需要的诸多扩展，最重要的就是<code>_C</code>这个拓展：</p> <div class="language-python extra-class"><pre class="language-python"><code>   <span class="token comment"># 声明一个Python拓展</span>
   C <span class="token operator">=</span> Extension<span class="token punctuation">(</span><span class="token string">&quot;torch._C&quot;</span><span class="token punctuation">,</span>
               libraries<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;torch_python&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               sources<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;torch/csrc/stub.c&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               language<span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">,</span>
               extra_compile_args<span class="token operator">=</span>main_compile_args <span class="token operator">+</span> extra_compile_args<span class="token punctuation">,</span>
               include_dirs<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
               library_dirs<span class="token operator">=</span>library_dirs<span class="token punctuation">,</span>
               extra_link_args<span class="token operator">=</span>extra_link_args <span class="token operator">+</span> main_link_args <span class="token operator">+</span> make_relative_rpath_args<span class="token punctuation">(</span><span class="token string">'lib'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   extensions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>C<span class="token punctuation">)</span>
</code></pre></div><p>从上面的代码中可以看到，<code>_C</code>的源码是<code>torch/csrc/stub.c</code>，它依赖<code>torch_python</code>这个库。可以说<code>_C</code>是一个入口，真正起作用的是<code>torch_python</code>，这个我们之后细讲。</p> <p>除了<code>_C</code>之外，Pytorch还需要一些拓展：</p> <ol><li>_dl：在Unix系统中使用动态库。</li> <li>shm：共享内存管理的库。</li></ol> <p>生成这些拓展后，这一步还会做一些简单的事，比如生成<code>setup</code>需要用到的命令，Pytorch中的资源文件等等。</p> <h3 id="setup"><a href="#setup" class="header-anchor">#</a> setup</h3> <p>最后一步是利用Python通用的生成库的函数<code>setup</code>来最终生成Pytorch这个库。</p> <p>至此我们走完了Pytorch生成的过程，下一步我们将深入依赖库的编译过程中。</p> <h2 id="cmake"><a href="#cmake" class="header-anchor">#</a> Cmake</h2> <p>上文提到，每一个工程，都会有一个<code>CMakeLists.txt</code>位于根目录中，cmake会将这个文件作为入口，开始编译的过程。在编译过程中，我们可以通过<code>add_subdirectory</code>这个函数来添加一个包含<code>CMakeLists.txt</code>的文件夹，cmake会进入这个文件夹，接着执行其中的<code>CMakeLists.txt</code>，这样可以形成一个树状的结构，直到运行结束所有的代码。这也是一个小技巧，我们可以通过搜索<code>add_subdirectory</code>来明确参与编译的目录。
我们先进入根目录的CMakeLists。</p> <h3 id="root-cmakelists"><a href="#root-cmakelists" class="header-anchor">#</a> root cmakelists</h3> <p>在这个文件中，我们做了如下这些事：</p> <ol><li>声明工程名字，这是CMake必需的</li> <li>确认使用C++14</li> <li>确定使用的CPU的架构，可能是INTEL或是AARCH64</li> <li>列出编译的可选选项，使用setup中的命令行选项</li> <li>引入Utils工具，用来简化代码</li> <li>设置版本号</li> <li><strong>编译第三方依赖库</strong></li> <li>根据不同的编译选项设置编译器的flags</li> <li><strong>核心编译部分</strong></li> <li>输出工程小结</li></ol> <p>我们需要关注7和9，在第7步中，我们利用Cmake寻找，编译好了<code>third_party</code>中的所有依赖库，在<code>third_party</code>中的每一个文件夹下，都含有一个<code>CMakeLists.txt</code>方便Cmake进行编译。</p> <p>在第9步中，我们引入了其他文件夹，开始源码的编译过程。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># ---[ Main build</span>
add_subdirectory<span class="token punctuation">(</span>c10<span class="token punctuation">)</span>
add_subdirectory<span class="token punctuation">(</span>caffe2<span class="token punctuation">)</span>
</code></pre></div><p>可以看到，我们引入了<code>c10</code>和<code>caffe2</code>两个文件夹，所以我们下一步就是进去这两个文件夹，看一下其中的编译过程。</p> <h3 id="c10-cmakelists"><a href="#c10-cmakelists" class="header-anchor">#</a> c10 cmakelists</h3> <p><code>c10</code>是一个独立的库，是Pytorch中Tensor的抽象，一开始位于<code>ATen/core</code>，现在被抽离出来形成了单独的一个库。</p> <p>为了更好地理解如何构建c10，我们给出精简过的<code>CMakeLists.txt</code>，其中省略了一些选项配置的部分。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 声明Cmake工程</span>
project<span class="token punctuation">(</span>c10 CXX<span class="token punctuation">)</span>
<span class="token comment"># 添加c10这个库</span>
add_library<span class="token punctuation">(</span>c10 <span class="token variable">${C10_SRCS}</span> <span class="token variable">${C10_HEADERS}</span><span class="token punctuation">)</span>
<span class="token comment"># 为c10添加依赖库</span>
target_link_libraries<span class="token punctuation">(</span>c10 PUBLIC gflags<span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>c10 PUBLIC glog::glog<span class="token punctuation">)</span>
<span class="token comment"># 添加c10的剩余部分</span>
add_subdirectory<span class="token punctuation">(</span>test<span class="token punctuation">)</span>
add_subdirectory<span class="token punctuation">(</span>benchmark<span class="token punctuation">)</span>
add_subdirectory<span class="token punctuation">(</span>cuda<span class="token punctuation">)</span>
<span class="token comment"># 将编译好的库安装到指定位置</span>
install<span class="token punctuation">(</span>TARGETS c10 EXPORT Caffe2Targets DESTINATION lib<span class="token punctuation">)</span>
install<span class="token punctuation">(</span>DIRECTORY <span class="token variable">${CMAKE_CURRENT_LIST_DIR}</span>
        DESTINATION include
        FILES_MATCHING PATTERN <span class="token string">&quot;*.h&quot;</span><span class="token punctuation">)</span>
install<span class="token punctuation">(</span>FILES <span class="token variable">${CMAKE_BINARY_DIR}</span>/c10/macros/cmake_macros.h
        DESTINATION include/c10/macros<span class="token punctuation">)</span>
</code></pre></div><p>从上述代码中可以看到，我们需要从当前文件夹中搜集c10的源文件和头文件，然后利用他们编译c10这个库，并为c10添加依赖库，然后将生成的库安装到指定位置方便后续使用。</p> <p>这是一个非常典型的Cmake编译过程，后面我们还会看到类似的代码，这里的逻辑与C++编译的过程是吻合的，不熟悉C++编译过程的读者请自行补充相关知识。</p> <h3 id="caffe-cmakelists"><a href="#caffe-cmakelists" class="header-anchor">#</a> caffe cmakelists</h3> <p>为了不让文章过于冗长，我隐藏了很多与配置编译选项有关的代码，只保留了代码生成和库定义的代码，这些代码可以帮助我们梳理Pytorch编译的过程，帮助我们梳理Pytorch的结构，如果需要更详细的对于编译代码的分析，请读者自行阅读源码。</p> <p>让我们开始最核心的，位于<code>caffe2</code>文件夹中的<code>CMakeLists.txt</code>。</p> <p>首先，我们引入另一个子文件<code>${ROOT}/cmake/Codegen.cmake</code>，在这个文件中，Pytorch<strong>动态生成</strong>了ATen所需要的代码，这是一个很关键的点。关于ATen代码的动态生成，我们将在下一篇文章中介绍，在这里不展开讲解。</p> <p>生成部分源代码之后，Pytorch选择了ATen的并行后端，可供选择的后端有：</p> <ol><li>NATIVE</li> <li>OMP -&gt; OpenMP</li> <li>TBB</li></ol> <p>之后开始了ATen的编译，我们通过<code>add_subdirectory(../aten aten)</code>进入ATen文件夹。在这里，我们并没有直接将ATen的源代码编译为一个独立的库，而是将所有ATen的源代码收集起来，然后传递回<code>caffe2</code>中，以供后续使用。</p> <p>一般来说，我们不需要用到<code>caffe2</code>，所以我们选择忽略掉大部分我们不需要的<code>caffe2</code>模块，只留下了：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>add_subdirectory<span class="token punctuation">(</span>core<span class="token punctuation">)</span>
add_subdirectory<span class="token punctuation">(</span>serialize<span class="token punctuation">)</span>
add_subdirectory<span class="token punctuation">(</span>utils<span class="token punctuation">)</span>
add_subdirectory<span class="token punctuation">(</span>perfkernels<span class="token punctuation">)</span>
add_subdirectory<span class="token punctuation">(</span>proto<span class="token punctuation">)</span>
</code></pre></div><p>我们之前收集的ATen源代码，会并入Cafee2的源代码，但由于我们没有包含<code>caffe2</code>模块，所以其他大部分代码还是ATen的，之后我们将ATen编译为<code>torch_cpu</code>，从这里开始真正构建<code>libtorch</code>。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>list<span class="token punctuation">(</span>APPEND Caffe2_CPU_SRCS <span class="token variable">${GENERATED_CXX_TORCH}</span> <span class="token variable">${GENERATED_H_TORCH}</span><span class="token punctuation">)</span>
<span class="token comment"># 创建torch_cpu库</span>
add_library<span class="token punctuation">(</span>torch_cpu <span class="token variable">${Caffe2_CPU_SRCS}</span><span class="token punctuation">)</span>
</code></pre></div><p>之后便是一些与<code>c10</code>中类似的结构，用于生成库，并为库添加依赖，如下代码所示：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 给 torch_cpu 添加链接库</span>
target_link_libraries<span class="token punctuation">(</span>torch_cpu PUBLIC c10<span class="token punctuation">)</span>
caffe2_interface_library<span class="token punctuation">(</span>torch_cpu torch_cpu_library<span class="token punctuation">)</span>

<span class="token comment"># 生成 torch_cuda 库</span>
cuda_add_library<span class="token punctuation">(</span>torch_cuda <span class="token variable">${Caffe2_GPU_SRCS}</span> <span class="token variable">${Caffe2_GPU_SRCS_W_SORT_BY_KEY}</span><span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>torch_cuda INTERFACE torch::cudart<span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>torch_cuda PUBLIC c10_cuda torch::nvtoolsext<span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>torch_cuda PUBLIC torch_cpu_library <span class="token variable">${Caffe2_PUBLIC_CUDA_DEPENDENCY_LIBS}</span><span class="token punctuation">)</span>
caffe2_interface_library<span class="token punctuation">(</span>torch_cuda torch_cuda_library<span class="token punctuation">)</span>

<span class="token comment"># 生成 torch 库</span>
add_library<span class="token punctuation">(</span>torch <span class="token variable">${DUMMY_EMPTY_FILE}</span>
caffe2_interface_library<span class="token punctuation">(</span>torch torch_library<span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>torch PUBLIC torch_cpu_library<span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>torch PUBLIC torch_cuda_library<span class="token punctuation">)</span>
</code></pre></div><p>从上面的代码中我们容易看到，<code>libtorch</code>只是一个外壳，里面包含了两个独立的库，<code>libtorch_cpu</code>和<code>lib_torch_cuda</code>，我们之后会用到的，也均是<code>libtorch</code>。同时注意到，他们都取了别名，在后续的构建中，都会使用别名来指代对应的库。</p> <p>我们完成这些库的构建后，还需要编译Python绑定(python binding)，借助<code>add_subdirectory(../torch torch)</code>来进行编译。</p> <h3 id="torch-cmakelists"><a href="#torch-cmakelists" class="header-anchor">#</a> torch cmakelists</h3> <p>直接贴上源码，这部分很容易梳理：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>set<span class="token punctuation">(</span>TORCH_PYTHON_SRCS
    <span class="token variable">${GENERATED_THNN_CXX}</span>
    <span class="token variable">${GENERATED_CXX_PYTHON}</span>
    <span class="token punctuation">)</span>
add_library<span class="token punctuation">(</span>torch_python SHARED <span class="token variable">${TORCH_PYTHON_SRCS}</span><span class="token punctuation">)</span>
target_link_libraries<span class="token punctuation">(</span>torch_python torch_library <span class="token variable">${TORCH_PYTHON_LINK_LIBRARIES}</span><span class="token punctuation">)</span>
install<span class="token punctuation">(</span>TARGETS torch_python DESTINATION <span class="token string">&quot;<span class="token variable">${TORCH_INSTALL_LIB_DIR}</span>&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>之前生成了一些代码，然后这些代码编译成了Pytorch的Python绑定。</p> <p>至此，Pytorch的编译完成。</p> <h2 id="编译过程中到底发生了什么"><a href="#编译过程中到底发生了什么" class="header-anchor">#</a> 编译过程中到底发生了什么</h2> <p>Pytorch的编译过程涉及了太多与Cmake和C++相关的知识，如果对他们不熟悉的读者，理解起来可能会有些吃力。</p> <p>所谓编译过程，其实就是盖房子，通过给定的图纸，一步一步建起一座大楼。
Pytorch中包含了许多C++库，编译主要就是要生成它们。每一个库都需要源代码，包含源文件和头文件，一个库还可能会依赖于其他库，这个时候就需要进行链接，最终形成一个库，这就是我们在上文中做的事情，不断寻找源文件，编译成库，再将这些库按需要链接在一起。</p> <h2 id="从中梳理pytorch的结构"><a href="#从中梳理pytorch的结构" class="header-anchor">#</a> 从中梳理Pytorch的结构</h2> <p>Pytorch就是这样一个库，一个混杂着python，c++和c的库，但每个部分都各司其职，井然有序，我们用一张图来对它的架构进行表示。</p> <p><img src="/blog/assets/img/structure.0eb99845.png" alt="Pytorch架构图"></p> <p>我们也可以使用<code>ldd</code>命令得到类似的结果，如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>_C.cpython-36m-x86_64-linux-gnu.so <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>/pytorch/torch/_C.cpython-36m-x86_64-linux-gnu.so <span class="token punctuation">(</span>interpreter <span class="token operator">=</span><span class="token operator">&gt;</span> none<span class="token punctuation">)</span>
   libtorch_python.so <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>/pytorch/torch/lib/libtorch_python.so
      libshm.so <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>/pytorch/torch/lib/libshm.so
      libtorch.so <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>/pytorch/torch/lib/libtorch.so
      libtorch_cpu.so <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>/pytorch/torch/lib/libtorch_cpu.so
      libtorch_cuda.so <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>/pytorch/torch/lib/libtorch_cuda.so
      libc10_cuda.so <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>/pytorch/torch/lib/libc10_cuda.so
      libc10.so <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">..</span>/pytorch/torch/lib/libc10.so
</code></pre></div><p>我们再回顾一下Pytorch中几个大的模块：</p> <ol><li>c10：Tensor的核心抽象，从ATen/core中抽离出来。</li> <li>ATen：Pytorch与Caffe2公用的计算后端。</li> <li>Caffe2：另一个深度学习框架，源于Caffe。</li> <li>Torch：Pytorch的源码，包含python与c++，c++部分位于<code>csrc</code>文件夹中。</li></ol> <p>所以现在出现了两个方向，如果想了解具体的计算部分，可以查看<code>c10</code>和<code>ATen</code>，如果想了解Pytorch内部的代码逻辑，比如自动微分以及模型推理，可以查看<code>Torch</code>。当然我们这个系列两个方向都会深入下去。</p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>相信各位读者现在已经明白了Pytorch的整体架构，理解架构对我们阅读源码是很有帮助的一件事。</p> <p>这篇文章比较长，里面也包含了较多代码上的细节，如果想要了解更详细的内容，需要读者亲自深入源码。<strong>同时也欢迎对文章有疑惑，有意见，有建议的读者与我们一同交流。</strong></p> <p>下一篇文章，我们将深入ATen的源码生成部分。</p></div><footer><!----><hr><!----></footer></article><div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h1 active"><a href="#如何从源码编译pytorch" title="如何从源码编译Pytorch？">如何从源码编译Pytorch？</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#前期准备工作" title="前期准备工作">前期准备工作</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#开始编译" title="开始编译">开始编译</a></div><div class="vuepress-toc-item vuepress-toc-h1"><a href="#pytorch编译过程解析" title="Pytorch编译过程解析">Pytorch编译过程解析</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#cmake-简要介绍" title="Cmake 简要介绍">Cmake 简要介绍</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#root" title="root">root</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#hello" title="Hello">Hello</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#demo" title="Demo">Demo</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#setup-py" title="setup.py">setup.py</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#命令行参数" title="命令行参数">命令行参数</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#编译依赖" title="编译依赖">编译依赖</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#整理pytorch需要的拓展" title="整理Pytorch需要的拓展">整理Pytorch需要的拓展</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#setup" title="setup">setup</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#cmake" title="Cmake">Cmake</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#root-cmakelists" title="root cmakelists">root cmakelists</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#c10-cmakelists" title="c10 cmakelists">c10 cmakelists</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#caffe-cmakelists" title="caffe cmakelists">caffe cmakelists</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#torch-cmakelists" title="torch cmakelists">torch cmakelists</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#编译过程中到底发生了什么" title="编译过程中到底发生了什么">编译过程中到底发生了什么</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#从中梳理pytorch的结构" title="从中梳理Pytorch的结构">从中梳理Pytorch的结构</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#结语" title="结语">结语</a></div></div></div></div> <footer class="footer" data-v-3908d95c><div class="footer-left-wrap" data-v-3908d95c><ul class="contact" data-v-3908d95c><li class="contact-item" data-v-3908d95c><a href="https://git.mediosz.club/Tric" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3908d95c><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-gitlab" data-v-3908d95c><path d="M22.65 14.39L12 22.13 1.35 14.39a.84.84 0 0 1-.3-.94l1.22-3.78 2.44-7.51A.42.42 0 0 1 4.82 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.49h8.1l2.44-7.51A.42.42 0 0 1 18.6 2a.43.43 0 0 1 .58 0 .42.42 0 0 1 .11.18l2.44 7.51L23 13.45a.84.84 0 0 1-.35.94z" data-v-3908d95c></path></svg>
          
        </a></li><li class="contact-item" data-v-3908d95c><a href="https://github.com/MediosZ" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3908d95c><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3908d95c><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3908d95c></path></svg>
          
        </a></li><li class="contact-item" data-v-3908d95c><a href="mailto:mediosrity@qq.com" class="nav-link external" data-v-3908d95c><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-3908d95c><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-3908d95c></path><polyline points="22,6 12,13 2,6" data-v-3908d95c></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3908d95c><ul class="copyright" data-v-3908d95c><li class="copyright-item" data-v-3908d95c><a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3908d95c>晋ICP备17009000</a></li></ul></div></footer></div><div class="global-ui"><!----><!----><!----></div></div>
    <script src="/blog/assets/js/app.bdc094dc.js" defer></script><script src="/blog/assets/js/6.e456ea1d.js" defer></script><script src="/blog/assets/js/3.78c3d3c8.js" defer></script><script src="/blog/assets/js/15.dab0a3f7.js" defer></script><script src="/blog/assets/js/10.70f7a74d.js" defer></script>
  </body>
</html>
